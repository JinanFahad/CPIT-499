<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØªØ¬Ø§Ø±ÙŠ â€” Ù…Ù‚Ø¯Ù‘Ù…</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:       #080c14;
    --surface:  #0f1520;
    --card:     #131c2e;
    --border:   #1e2d45;
    --accent:   #2563eb;
    --accent2:  #38bdf8;
    --gold:     #f59e0b;
    --text:     #e2e8f0;
    --muted:    #64748b;
    --user-bg:  #1e3a5f;
    --ai-bg:    #111827;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Cairo', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© â”€â”€ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 20%, rgba(37,99,235,.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 60% at 80% 80%, rgba(56,189,248,.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    background: rgba(15,21,32,.95);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    z-index: 10;
    backdrop-filter: blur(12px);
  }

  .header .back-btn {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 7px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Cairo', sans-serif;
    font-size: 13px;
    transition: all .2s;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .header .back-btn:hover { border-color: var(--accent); color: var(--text); }

  .header .advisor-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
  }

  .advisor-avatar {
    width: 42px; height: 42px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    box-shadow: 0 0 20px rgba(37,99,235,.4);
  }

  .advisor-name { font-size: 15px; font-weight: 700; }
  .advisor-status {
    font-size: 11px;
    color: #22c55e;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .advisor-status::before {
    content: '';
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #22c55e;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

  .header .brand { margin-right: auto; font-size: 12px; color: var(--muted); letter-spacing: 3px; }

  /* â”€â”€ LAYOUT â”€â”€ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar {
    width: 300px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 16px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: .5px;
  }

  .reports-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }
  .reports-list::-webkit-scrollbar { width: 3px; }
  .reports-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .report-item {
    padding: 12px 14px;
    border-radius: 10px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all .2s;
    margin-bottom: 6px;
  }
  .report-item:hover { background: var(--card); border-color: var(--border); }
  .report-item.active { background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.4); }

  .report-item .r-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
  .report-item .r-meta { font-size: 11px; color: var(--muted); display: flex; gap: 8px; }
  .report-item .r-type {
    background: rgba(37,99,235,.15);
    color: var(--accent2);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
  }

  .empty-reports {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
  }
  .empty-reports .icon { font-size: 36px; margin-bottom: 10px; opacity: .4; }

  .loading-reports {
    padding: 20px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
  }

  /* â”€â”€ CHAT AREA â”€â”€ */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Ø­Ø§Ù„Ø©: Ø§Ø®ØªØ± Ø¯Ø±Ø§Ø³Ø© */
  .select-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--muted);
    text-align: center;
    padding: 40px;
  }
  .select-state .big-icon { font-size: 64px; opacity: .2; }
  .select-state h2 { font-size: 20px; font-weight: 700; color: var(--text); opacity: .5; }
  .select-state p { font-size: 14px; max-width: 300px; line-height: 1.7; }

  /* Ø´Ø±ÙŠØ· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© */
  .report-bar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    display: none;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .report-bar.visible { display: flex; }
  .report-bar .rb-item { text-align: center; }
  .report-bar .rb-val { font-size: 16px; font-weight: 900; color: var(--accent2); }
  .report-bar .rb-key { font-size: 10px; color: var(--muted); }
  .report-bar .rb-divider { width: 1px; height: 30px; background: var(--border); }
  .report-bar .rb-title { font-size: 13px; font-weight: 700; margin-left: auto; }

  /* Ø±Ø³Ø§Ø¦Ù„ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .msg {
    display: flex;
    gap: 10px;
    max-width: 75%;
    animation: msgIn .3s ease;
  }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg.user { margin-right: auto; flex-direction: row-reverse; }
  .msg.ai   { margin-left: auto; }

  .msg-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .msg.user .msg-avatar { background: var(--user-bg); }
  .msg.ai   .msg-avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow: 0 0 12px rgba(37,99,235,.3); }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 13.5px;
    line-height: 1.8;
    white-space: pre-wrap;
  }
  .msg.user .msg-bubble {
    background: var(--user-bg);
    border: 1px solid rgba(37,99,235,.3);
    border-radius: 16px 4px 16px 16px;
  }
  .msg.ai .msg-bubble {
    background: var(--ai-bg);
    border: 1px solid var(--border);
    border-radius: 4px 16px 16px 16px;
  }

  .msg-time { font-size: 10px; color: var(--muted); margin-top: 4px; text-align: left; }

  /* typing indicator */
  .typing-indicator {
    display: none;
    align-items: center;
    gap: 10px;
    margin-left: auto;
    padding: 0 4px;
  }
  .typing-indicator.visible { display: flex; }
  .typing-dots { display: flex; gap: 4px; }
  .typing-dots span {
    width: 7px; height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: bounce .8s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: .15s; }
  .typing-dots span:nth-child(3) { animation-delay: .3s; }
  @keyframes bounce { 0%,80%,100%{transform:scale(0.6);opacity:.4} 40%{transform:scale(1);opacity:1} }

  /* â”€â”€ INPUT â”€â”€ */
  .input-area {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 14px 20px;
  }

  .suggested-questions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .sq-btn {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-family: 'Cairo', sans-serif;
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .sq-btn:hover { border-color: var(--accent); color: var(--accent2); }

  .input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  textarea {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
    padding: 12px 16px;
    resize: none;
    outline: none;
    min-height: 48px;
    max-height: 140px;
    line-height: 1.6;
    transition: border-color .2s;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }
  textarea:disabled { opacity: .4; }

  .send-btn {
    width: 48px; height: 48px;
    background: var(--accent);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: all .2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .send-btn:hover:not(:disabled) { background: #1d4ed8; transform: scale(1.05); }
  .send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }

  /* welcome message */
  .welcome-msg {
    background: linear-gradient(135deg, rgba(37,99,235,.08), rgba(56,189,248,.05));
    border: 1px solid rgba(37,99,235,.2);
    border-radius: 16px;
    padding: 20px 22px;
    margin-bottom: 8px;
  }
  .welcome-msg h3 { font-size: 15px; font-weight: 700; margin-bottom: 8px; color: var(--accent2); }
  .welcome-msg p  { font-size: 13px; color: #94a3b8; line-height: 1.7; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <a class="back-btn" href="#">â† Ø±Ø¬ÙˆØ¹</a>
  <div class="advisor-info">
    <div class="advisor-avatar">ğŸ¤–</div>
    <div>
      <div class="advisor-name">Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</div>
      <div class="advisor-status">Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†</div>
    </div>
  </div>
  <div class="brand">MUQADDIM</div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- CHAT -->
  <div class="chat-area">

    <!-- Ø´Ø±ÙŠØ· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø© -->
    <div class="report-bar" id="reportBar">
      <div class="rb-item">
        <div class="rb-val" id="barRevenue">â€”</div>
        <div class="rb-key">Ø¥ÙŠØ±Ø§Ø¯ Ø´Ù‡Ø±ÙŠ</div>
      </div>
      <div class="rb-divider"></div>
      <div class="rb-item">
        <div class="rb-val" id="barMargin">â€”</div>
        <div class="rb-key">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­</div>
      </div>
      <div class="rb-divider"></div>
      <div class="rb-item">
        <div class="rb-val" id="barPayback">â€”</div>
        <div class="rb-key">ÙØªØ±Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</div>
      </div>
      <div class="rb-divider"></div>
      <div class="rb-item">
        <div class="rb-val" id="barDecision">â€”</div>
        <div class="rb-key">Ø§Ù„Ù‚Ø±Ø§Ø±</div>
      </div>
      <div class="rb-title" id="barTitle"></div>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="messages" id="messages">
      <div class="select-state" id="selectState">
        <div class="big-icon">ğŸ’¼</div>
        <h2>Ø§Ø®ØªØ± Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰</h2>
        <p>Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ø­Ø¯Ù‰ Ø¯Ø±Ø§Ø³Ø§ØªÙƒ Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø±</p>
      </div>
    </div>

    <!-- Typing -->
    <div class="typing-indicator" id="typingIndicator" style="padding: 0 24px 10px">
      <div class="msg-avatar" style="background:linear-gradient(135deg,#2563eb,#38bdf8);width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px">ğŸ¤–</div>
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- INPUT -->
    <div class="input-area" id="inputArea">
      <div class="suggested-questions" id="suggestedQ" style="display:none">
        <button class="sq-btn" onclick="askQuestion(this)">Ø§ÙŠØ´ Ù…Ø¹Ù†Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„ØŸ</button>
        <button class="sq-btn" onclick="askQuestion(this)">Ù‡Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ØŸ</button>
        <button class="sq-btn" onclick="askQuestion(this)">ÙƒÙŠÙ Ø£Ø±ÙØ¹ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ØŸ</button>
        <button class="sq-btn" onclick="askQuestion(this)">Ù…Ø§ Ù‡ÙŠ Ø£Ø¨Ø±Ø² Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŸ</button>
      </div>
      <div class="input-row">
        <textarea
          id="msgInput"
          placeholder="Ø§Ø®ØªØ± Ø¯Ø±Ø§Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹..."
          rows="1"
          disabled
          onkeydown="handleKey(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>â¤</button>
      </div>
    </div>

  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">ğŸ“‚ Ø¯Ø±Ø§Ø³Ø§ØªÙŠ</div>
    <div class="reports-list" id="reportsList">
      <div class="loading-reports">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

</div>

<script>
  let selectedReportId = null;
  let selectedReport   = null;
  let history          = [];

  const BUSINESS_LABELS = {
    "pizza_restaurant":       "ğŸ• Ø¨ÙŠØªØ²Ø§",
    "fast_food_restaurant":   "ğŸ” ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©",
    "cafe":                   "â˜• ÙƒØ§ÙÙŠÙ‡",
    "seafood_restaurant":     "ğŸ¦ Ù…Ø£ÙƒÙˆÙ„Ø§Øª Ø¨Ø­Ø±ÙŠØ©",
    "breakfast_restaurant":   "ğŸ¥š ÙØ·ÙˆØ±",
    "sandwich_shop":          "ğŸ¥ª Ø³Ø§Ù†Ø¯ÙˆÙŠØªØ´",
    "shawarma_restaurant":    "ğŸŒ¯ Ø´Ø§ÙˆØ±Ù…Ø§",
    "traditional_restaurant": "ğŸ– Ù…Ø·Ø¹Ù… Ø´Ø¹Ø¨ÙŠ",
    "restaurant":             "ğŸ½ï¸ Ù…Ø·Ø¹Ù…",
  };

  // â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadReports() {
    try {
      const res  = await fetch("/api/reports");
      const data = await res.json();

      const list = document.getElementById("reportsList");

      if (!data.length) {
        list.innerHTML = `
          <div class="empty-reports">
            <div class="icon">ğŸ“‹</div>
            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø§Ø³Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</div>
          </div>`;
        return;
      }

      list.innerHTML = data.map(r => `
        <div class="report-item" onclick="selectReport(${r.id})" id="ri-${r.id}">
          <div class="r-title">${r.title || "Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆÙ‰"}</div>
          <div class="r-meta">
            <span>${r.city || "â€”"}</span>
            <span class="r-type">${BUSINESS_LABELS[r.business_type] || r.business_type}</span>
          </div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">
            ${new Date(r.created_at).toLocaleDateString("ar-SA")}
          </div>
        </div>
      `).join("");

    } catch (e) {
      document.getElementById("reportsList").innerHTML =
        `<div class="loading-reports" style="color:#f87171">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª</div>`;
    }
  }

  // â”€â”€ Ø§Ø®ØªÙŠØ§Ø± Ø¯Ø±Ø§Ø³Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function selectReport(id) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ active
    document.querySelectorAll(".report-item").forEach(el => el.classList.remove("active"));
    document.getElementById(`ri-${id}`)?.classList.add("active");

    selectedReportId = id;
    history = [];

    try {
      const res    = await fetch(`/api/reports/${id}`);
      selectedReport = await res.json();

      // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
      const fs = selectedReport.financial_summary || {};
      const d  = selectedReport.decision || {};

      document.getElementById("barRevenue").textContent  = (fs.monthly_revenue  ? fs.monthly_revenue.toLocaleString("ar") + " Ø±.Ø³" : "â€”");
      document.getElementById("barMargin").textContent   = (fs.profit_margin_percent ? fs.profit_margin_percent + "%" : "â€”");
      document.getElementById("barPayback").textContent  = (fs.payback_period_months ? fs.payback_period_months.toFixed(1) + " Ø´Ù‡Ø±" : "â€”");
      document.getElementById("barTitle").textContent    = selectedReport.title || "";

      const cls = (d.classification || "").toLowerCase();
      const decisionEl = document.getElementById("barDecision");
      if (cls.includes("suitable")) { decisionEl.textContent = "âœ… Ù…Ù†Ø§Ø³Ø¨"; decisionEl.style.color = "#22c55e"; }
      else if (cls.includes("moderate")) { decisionEl.textContent = "âš ï¸ Ù…ØªÙˆØ³Ø·"; decisionEl.style.color = "#f59e0b"; }
      else { decisionEl.textContent = "ğŸ”´ Ù…Ø®Ø§Ø·Ø±Ø©"; decisionEl.style.color = "#f87171"; }

      document.getElementById("reportBar").classList.add("visible");

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      const input = document.getElementById("msgInput");
      input.disabled = false;
      input.placeholder = "Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø¯Ø±Ø§Ø³Ø© Ø¬Ø¯ÙˆØ§Ùƒ...";
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("suggestedQ").style.display = "flex";

      // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
      const messages = document.getElementById("messages");
      document.getElementById("selectState")?.remove();
      messages.innerHTML = "";

      addMessage("ai", `Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ù„Ø¯Ø±Ø§Ø³Ø© **${selectedReport.title || "Ø¬Ø¯ÙˆÙ‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"}**.\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø¤Ø§Ù„ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© â€” Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ Ø§Ù„ØªÙˆØµÙŠØ§ØªØŒ Ø£Ùˆ ÙƒÙŠÙÙŠØ© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹. Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø£Ø³Ø§Ø¹Ø¯Ùƒ! ğŸ’¼`);

    } catch (e) {
      console.error(e);
    }
  }

  // â”€â”€ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendMessage() {
    const input = document.getElementById("msgInput");
    const msg   = input.value.trim();

    if (!msg || !selectedReportId) return;

    input.value = "";
    autoResize(input);
    input.disabled = true;
    document.getElementById("sendBtn").disabled = true;
    document.getElementById("suggestedQ").style.display = "none";

    addMessage("user", msg);
    showTyping(true);

    try {
      const res  = await fetch("/api/advisor/chat", {
        method:  "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          report_id: selectedReportId,
          message:   msg,
          history:   history,
        }),
      });

      const data = await res.json();
      showTyping(false);

      if (data.error) {
        addMessage("ai", "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + data.error);
      } else {
        history = data.history;
        addMessage("ai", data.reply);
      }

    } catch (e) {
      showTyping(false);
      addMessage("ai", "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
    }

    input.disabled = false;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("suggestedQ").style.display = "flex";
    input.focus();
  }

  // â”€â”€ Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚ØªØ±Ø­Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function askQuestion(btn) {
    const input = document.getElementById("msgInput");
    input.value = btn.textContent;
    sendMessage();
  }

  // â”€â”€ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addMessage(role, text) {
    const messages = document.getElementById("messages");

    const now  = new Date().toLocaleTimeString("ar-SA", { hour: "2-digit", minute: "2-digit" });
    const isAI = role === "ai";

    const div = document.createElement("div");
    div.className = `msg ${isAI ? "ai" : "user"}`;
    div.innerHTML = `
      <div class="msg-avatar">${isAI ? "ğŸ¤–" : "ğŸ‘¤"}</div>
      <div>
        <div class="msg-bubble">${formatText(text)}</div>
        <div class="msg-time">${now}</div>
      </div>
    `;

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ â€” **bold** â†’ <strong>
  function formatText(text) {
    return text
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\n/g, "<br>");
  }

  // â”€â”€ typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showTyping(show) {
    const el = document.getElementById("typingIndicator");
    if (show) {
      el.classList.add("visible");
      document.getElementById("messages").scrollTop = 9999;
    } else {
      el.classList.remove("visible");
    }
  }

  // â”€â”€ Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleKey(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  // â”€â”€ auto resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function autoResize(el) {
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 140) + "px";
  }

  // â”€â”€ ØªØ´ØºÙŠÙ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadReports();
</script>
</body>
</html>